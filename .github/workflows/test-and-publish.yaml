name: 'Test and Publish Suite'

on:
  push:
    branches:
      - main
    tags:
      - '*'
  workflow_call:
  workflow_dispatch:
  pull_request:

env:
  # don't upgrade outdated brew packages because the process is too slow
  HOMEBREW_NO_INSTALL_UPGRADE: 1
  HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1

jobs:
  build-spidermonkey:
    strategy:
      matrix:
        # Use Ubuntu 20.04 / macOS 12 + Python 3.8 to build SpiderMonkey
        os: [ 'ubuntu-20.04', 'macos-12' ] # , 'windows-latest' ]
        python_version: [ '3.8' ]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python_version }}
      - name: Cache spidermonkey build
        id: cache-spidermonkey
        uses: actions/cache@v3
        with:
          path: |
            ./_spidermonkey_install/*
          key: ${{ runner.os }}-spidermonkey
          lookup-only: true # skip download
      - name: Build spidermonkey
        if: ${{ steps.cache-spidermonkey.outputs.cache-hit != 'true' }}
        run: ./setup.sh
  build-and-test:
    needs: build-spidermonkey
    strategy:
      fail-fast: false
      matrix:
        # The lowest supported version is Ubuntu 20.04 + Python 3.8 or macOS 12 + Python 3.9
        os: [ 'ubuntu-20.04', 'macos-12' ] # , 'windows-latest' ]
        python_version: [ '3.8', '3.9', '3.10', '3.11', '3.12-dev' ]
        exclude:
          # macOS 12 comes with Python 3.9 by default, so we drop ci support for Python 3.8 on macOS
          # FIXME: We can't build on macOS 11 for now because our prebuilt `uncrustify` binary requires macOS 12
          - os: 'macos-12'
            python_version: '3.8'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python_version }}
      - name: Setup Poetry
        uses: snok/install-poetry@v1
      - name: Install Dependencies
        run: |
          echo "Installing Dependencies"
          if [[ "$OSTYPE" == "linux-gnu"* ]]; then # Linux
            sudo apt-get update -y
            sudo apt-get install -y cmake doxygen graphviz llvm
          elif [[ "$OSTYPE" == "darwin"* ]]; then # macOS
            brew update
            brew install cmake doxygen graphviz pkg-config wget coreutils # `coreutils` installs the `realpath` command
          fi
          echo "Installing python deps"
          poetry install --no-root
          echo "Installed Dependencies"
      - name: Use cached spidermonkey build
        uses: actions/cache@v3
        with:
          path: |
            ./_spidermonkey_install/*
          key: ${{ runner.os }}-spidermonkey
          fail-on-cache-miss: true # SpiderMonkey is expected to be cached in its dedicated job
      - name: Build wheel
        run: |
          echo $(poetry run python --version)
          poetry build --format=wheel
          ls -lah ./dist/
      - name: Upload wheel as CI artifacts
        uses: actions/upload-artifact@v3
        with:
          name: wheel-${{ github.run_id }}-${{ github.sha }}
          path: ./dist/
      - name: Run Python tests (pytest)
        run: |
          poetry run python -m pip install ./dist/*.whl
          poetry run python -m pytest tests/python
  sdist:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Setup Poetry
        uses: snok/install-poetry@v1
      - name: Build source distribution (sdist) file
        run: |
          poetry build --format=sdist
          ls -lah ./dist/
      - name: Upload sdist as CI artifacts
        uses: actions/upload-artifact@v3
        with:
          name: wheel-${{ github.run_id }}-${{ github.sha }}
          path: ./dist/
  publish:
    needs: [build-and-test, sdist]
    runs-on: ubuntu-20.04
    if: ${{ success() && github.event_name == 'push' && contains(github.ref, 'refs/tags/') }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Setup Poetry
        uses: snok/install-poetry@v1
      - name: Download wheels built
        uses: actions/download-artifact@v3
        with:
          name: wheel-${{ github.run_id }}-${{ github.sha }}
          path: ./dist/
      - run: ls -lah ./dist/
      - name: Publish package
        run: |
          poetry publish \
            --no-interaction --skip-existing \
            --username __token__ --password ${{ secrets.PYPI_API_TOKEN }}
  publish-nightly:
    # Implement a very basic Python package repository (https://peps.python.org/pep-0503/)
    # and deploy the static files to GitHub Pages
    needs: [build-and-test, sdist]
    runs-on: ubuntu-20.04
    if: ${{ (success() || failure()) && github.ref_name == 'main' }} # publish nightly builds regardless of tests failure
    permissions: # grant GITHUB_TOKEN the permissions required to make a Pages deployment
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # don't checkout
      - name: Download wheels built
        uses: actions/download-artifact@v3
        with:
          name: wheel-${{ github.run_id }}-${{ github.sha }}
          path: ./pythonmonkey/ # write to the repository project path 
      - name: Generate index page for the project
        run: |
          cd ./pythonmonkey/
          html="<html><head><title>PythonMonkey Nightly Builds</title></head><body>"
          for file in ./*; do # generate <a> tags for each file
            html+="<a href=\"$file\">$file</a><br/>"
          done
          html+="</body></html>"
          echo "$html" > ./index.html
      - name: Generate repository root page
        run: |
          html="<html><head><title>PythonMonkey Nightly Builds</title></head><body>"
          html+="<h1>PythonMonkey Nightly Builds</h1>"
          html+="<p>To install nightly builds, run</p>"
          html+="<pre>pip install -i https://distributive-network.github.io/PythonMonkey/ pythonmonkey</pre>"
          html+="<h3>Browse files:</h3>"
          html+="<a href="pythonmonkey/">pythonmonkey</a>"
          html+="</body></html>"
          echo "$html" > ./index.html
      - uses: actions/upload-pages-artifact@v1
        with:
          path: ./
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

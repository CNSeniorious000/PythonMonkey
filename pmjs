#! /usr/bin/env python3
# @file         pmjs - PythonMonkey REPL
# @author       Wes Garland, wes@distributive.network
# @date         June 2023

import sys, os, cmd
sys.path.append(os.path.dirname(__file__) + '/python') # location of pythonmonkey module
import pythonmonkey as pm

globalThis = pm.eval("globalThis;")
pm.createRequire(__file__)('./pmjs-require')

globalThis.python.isCompilableUnit = pm.isCompilableUnit
globalThis.python.exit = sys.exit

def write(buf: str):
    print(buf, end="")
globalThis.python.write = write

pm.eval("""
const cmds = {
  help: function help() {
    return '' +
`.exit     Exit the REPL
.help     Print this help message
.load     Load JS from a file into the REPL session
.save     Save all evaluated commands in this REPL session to a file

Press Ctrl+C to abort current expression, Ctrl+D to exit the REPL`
  },
};

globalThis.replEval = function replEval(line)
{
  const lineBuf = [];

  try
  {
    if (line[0] === '.')
      return cmds[line.slice(1)]();
    if (line === 'EOF')
      python.exit('');
    lineBuf.push(line);
    line = lineBuf.join(String.fromCharCode(10));

    if (python.isCompilableUnit(line))
      lineBuf.length = 0;
    else
    {
      python.write('... ');
      return; /* Back to REPL for more of JS expression */
    }

    const result = eval(line);
    switch (typeof result)
    {
      case 'string':
      case 'number':
      case 'boolean':
        return result;
      case 'object':
        if (result instanceof Error)
          return result.stack || result.message;
        return JSON.stringify(result);
      case 'function':
        return String(result);
      default:
        return `<unknown type ${typeof result}>${result}`;
    }
  }
  catch(error)
  {
    return error.stack || result.message;
  }
}
""");

class JSShell(cmd.Cmd):
    intro = 'Welcome to PythonMonkey v' + pm.__version__ +'.\nType ".help" for more information.';

    prompt = '> '

    def parseline(self, line):
        print(globalThis.replEval(line))
        dummyRet = cmd.Cmd.parseline(self, '')
        return dummyRet

if __name__ == '__main__':
    JSShell().cmdloop()
